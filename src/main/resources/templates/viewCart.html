<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho de Compras</title>

  <link rel="stylesheet" th:href="@{/css/dash.css}">
  <link rel="stylesheet" th:href="@{/css/carrinho.css}">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>

  <div class="divHeader">
    <img src="../assets/Banners/logo.png"style="max-width: 7%;height: auto;">
    <nav>

        <a href="/client/home"> Home</a>
        <a href=""> Minha Conta</a>
        <a href="/client/cart">Carrinho</a>

        <span></span>

    </nav>
</div>
<div class="atencao">
  <h2> ATENÇÃO:Possíveis atrasos nas entregas devido as fortes chuvas na região sul do país</h2>  
</div>

<div class="container mt-5">
  <h2>Seu Carrinho</h2>
  <div th:if="${#lists.isEmpty(cart.items)}">
    <p>Seu carrinho está vazio.</p>
  </div>
  <div th:if="${not #lists.isEmpty(cart.items)}">
    <table class="table">
      <thead>
      <tr>
        <th>Produto</th>
        <th>Preço</th>
        <th>Quantidade</th>
        <th>Subtotal</th>
        <th>Ações</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${cart.items}">
        <td th:text="${item.product.productName}">Nome do Produto</td>
        <td th:text="${item.product.price}">Preço</td>
        <td>
          <button onclick="changeQuantity(this, -1)">-</button>
          <span th:text="${item.quantity}">1</span>
          <button onclick="changeQuantity(this, 1)">+</button>
        </td>
        <td th:text="${item.product.price * item.quantity}">Subtotal</td>
        <td>
          <form th:action="@{/client/cart/remove}" method="post">
            <input type="hidden" name="itemId" th:value="${item.id}" />
            <button type="submit" class="btn btn-danger">Remover</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
    <h4>Opções de Frete:</h4>
    <select id="shippingOptions" onchange="updateShipping()">
      <option value="25">Normal (5-4 dias) - R$25</option>
      <option value="40">Express (3-2 dias) - R$40</option>
      <option value="100">Entrega Flash (1 dia) - R$100</option>
    </select>
    <h3>Total: <span id="total">0</span></h3>
    <button class="btn btn-success" onclick="finalizePurchase()">Finalizar Compra</button>
  </div>
</div>

<!-- Login/Cadastro Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Acesso ao Sistema</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <!-- Login Form -->
            <div class="col-md-6">
              <form method="post" action="/client/login">
                <div class="form-group">
                  <label for="email">Email:</label>
                  <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="form-group">
                  <label for="password">Senha:</label>
                  <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
              </form>
            </div>
            <!-- Cadastro Link -->
            <div class="col-md-6">
              <h4>Não tem uma conta?</h4>
              <p>Registre-se para uma nova conta para concluir sua compra.</p>
              <a href="/client/register" class="btn btn-success">Cadastre-se</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let shippingCost = 25; // Valor inicial de frete

function changeQuantity(element, change) {
    let quantityElement = element.parentNode.querySelector('span');
    let quantity = parseInt(quantityElement.innerText) + change;
    if (quantity < 1) quantity = 1;
    quantityElement.innerText = quantity;
    updateSubtotals();
}

function updateSubtotals() {
    const rows = document.querySelectorAll('tbody tr');
    let total = 0;
    rows.forEach(row => {
        const price = parseFloat(row.cells[1].innerText);
        const quantity = parseInt(row.cells[2].querySelector('span').innerText);
        const subtotal = price * quantity;
        row.cells[3].innerText = subtotal.toFixed(2);
        total += subtotal;
    });
    document.getElementById('total').innerText = (total + shippingCost).toFixed(2);
}

function updateShipping() {
    shippingCost = parseFloat(document.getElementById('shippingOptions').value);
    updateSubtotals();
}

function finalizePurchase() {
    fetch('/client/check-login')
        .then(response => response.json())
        .then(data => {
            if (data.loggedIn) {
                window.location.href = '/client/checkout'; // Usuário logado, ir para checkout
            } else {
                // Abre o modal de login/cadastro
                $('#loginModal').modal('show');
            }
        });
}
</script>
</body>
</html>
