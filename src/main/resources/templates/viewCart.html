<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrinho de Compras</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" th:href="@{/css/custom.css}">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container mt-5">
  <h2>Seu Carrinho</h2>
  <div th:if="${#lists.isEmpty(cart.items)}">
    <p>Seu carrinho está vazio.</p>
  </div>
  <div th:if="${not #lists.isEmpty(cart.items)}">
    <table class="table">
      <thead>
      <tr>
        <th>Produto</th>
        <th>Preço</th>
        <th>Quantidade</th>
        <th>Subtotal</th>
        <th>Ação</th>
      </tr>
      </thead>
      <tbody>
      <tr th:each="item : ${cart.items}">
        <td th:text="${item.product.productName}">Nome do Produto</td>
        <td th:text="${item.product.price}">Preço</td>
        <td th:text="${item.quantity}">Quantidade</td>
        <td th:text="${item.product.price * item.quantity}">Subtotal</td>
        <td>
          <form th:action="@{/client/cart/remove}" method="post">
            <input type="hidden" name="itemId" th:value="${item.id}" />
            <button type="submit" class="btn btn-danger">Remover</button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
    <div>
      <h4>Total: <span th:text="${#numbers.formatDecimal(cart.total, 1, 'COMMA', 2, 'POINT')}">0,00</span></h4>
    </div>
    <div>
      <h4>Opções de Frete:</h4>
      <select id="shippingOptions">
        <option value="25">Normal (5-7 dias) - R$25</option>
        <option value="50">Express (2-3 dias) - R$50</option>
      </select>
    </div>
    <div th:if="${userLoggedIn}">
      <h4>Endereço de Entrega:</h4>
      <p th:text="${defaultAddress.logradouro + ', ' + defaultAddress.numero + ' - ' + defaultAddress.bairro + ', ' + defaultAddress.cidade + ' - ' + defaultAddress.uf}"></p>
      <a href="#" class="btn btn-link">Selecionar outro</a>
    </div>
    <div th:if="${!userLoggedIn}">
      <h4>Informe seu CEP para entrega:</h4>
      <input type="text" id="cep" placeholder="Digite seu CEP" pattern="\d{5}-?\d{3}" required>
      <button type="button" onclick="buscarCep()">Buscar CEP</button>
      <div id="enderecoInfo" style="display:none;">
        <p id="logradouro"></p>
        <p id="bairro"></p>
        <p id="cidade"></p>
        <p id="uf"></p>
      </div>
    </div>
    <button class="btn btn-success" th:if="${userLoggedIn}" onclick="window.location.href='/client/payment'">Prosseguir para Pagamento</button>
    <button class="btn btn-primary" th:if="${!userLoggedIn}" data-toggle="modal" data-target="#loginModal">Logar ou Registrar para continuar</button>
  </div>
</div>

<!-- Login/Cadastro Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Acesso ao Sistema</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="row">
            <!-- Login Form -->
            <div class="col-md-6">
              <form method="post" action="/client/login">
                <div class="form-group">
                  <label for="email">Email:</label>
                  <input type="email" class="form-control" id="email" name="email" required>
                </div>
                <div class="form-group">
                  <label for="password">Senha:</label>
                  <input type="password" class="form-control" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
              </form>
            </div>
            <!-- Cadastro Link -->
            <div class="col-md-6">
              <h4>Não tem uma conta?</h4>
              <p>Registre-se para uma nova conta para concluir sua compra.</p>
              <a href="/client/register" class="btn btn-success">Cadastre-se</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function buscarCep() {
    var cep = document.getElementById('cep').value.replace(/\D/g, ''); // Limpa o valor do CEP
    if (cep.length === 8) {
        $.ajax({
            url: `https://viacep.com.br/ws/${cep}/json/`,
            type: 'GET',
            success: function(data) {
                if (!data.erro) {
                    document.getElementById('enderecoInfo').style.display = 'block';
                    document.getElementById('logradouro').innerText = 'Logradouro: ' + data.logradouro;
                    document.getElementById('bairro').innerText = 'Bairro: ' + data.bairro;
                    document.getElementById('cidade').innerText = 'Cidade: ' + data.localidade;
                    document.getElementById('uf').innerText = 'UF: ' + data.uf;
                } else {
                    alert('CEP não encontrado!');
                }
            },
            error: function() {
                alert('Erro ao buscar o CEP!');
            }
        });
    } else {
        alert('CEP deve conter 8 dígitos.');
    }
}
</script>
</body>
</html>
